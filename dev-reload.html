<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDA Development - Auto Reload</title>
    <link rel="preload" href="assets/FinalCover.png" as="image">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        iframe {
            width: 100vw;
            height: 100vh;
            border: none;
        }
        .reload-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #4CAF50;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-family: Arial;
            font-size: 12px;
            z-index: 9999;
            display: none;
        }
        .reload-indicator.active {
            display: block;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="reload-indicator" id="reloadIndicator">Auto-Reload Active</div>
    <iframe id="appFrame" src=""></iframe>
    
    <script>
        // Get page from URL parameter or default to index
        const urlParams = new URLSearchParams(window.location.search);
        let targetPage = urlParams.get('page') || 'automatic-mode.html';
        
        // Ensure .html extension
        if (!targetPage.endsWith('.html')) {
            targetPage += '.html';
        }
        
        // Set iframe source
        const iframe = document.getElementById('appFrame');
        iframe.src = targetPage;
        
        // Update page title
        document.title = `Dev: ${targetPage}`;
        
        // Auto-reload configuration
        const CHECK_INTERVAL = 1000; // Check every 1 second
        const FILES_TO_WATCH = [
            'style/app.css',
            targetPage,  // Watch the current page
            'js/shared-rules.js',
            'js/automatic-mode.js',
            'js/control-screen.js',
            'js/modal-handler.js'
        ];
        
        let lastModified = {};
        const indicator = document.getElementById('reloadIndicator');
        
        // Initialize last modified times
        async function initializeWatcher() {
            for (const file of FILES_TO_WATCH) {
                try {
                    const response = await fetch(file, { method: 'HEAD' });
                    lastModified[file] = response.headers.get('Last-Modified');
                } catch (e) {
                    console.log(`Could not check ${file}`);
                }
            }
            indicator.classList.add('active');
            console.log('Auto-reload initialized. Watching files:', FILES_TO_WATCH);
        }
        
        // Check for changes
        async function checkForChanges() {
            for (const file of FILES_TO_WATCH) {
                try {
                    const response = await fetch(file, { method: 'HEAD', cache: 'no-cache' });
                    const currentModified = response.headers.get('Last-Modified');
                    
                    if (lastModified[file] && lastModified[file] !== currentModified) {
                        console.log(`File changed: ${file}`);
                        lastModified[file] = currentModified;
                        
                        // Reload iframe
                        iframe.src = iframe.src;
                        
                        // Flash indicator
                        indicator.style.background = '#ff9800';
                        indicator.textContent = 'Reloading...';
                        setTimeout(() => {
                            indicator.style.background = '#4CAF50';
                            indicator.textContent = 'Auto-Reload Active';
                        }, 1000);
                    }
                    
                    lastModified[file] = currentModified;
                } catch (e) {
                    // Ignore errors
                }
            }
        }
        
        // Start watching
        initializeWatcher();
        setInterval(checkForChanges, CHECK_INTERVAL);
        
        // Allow manual reload with F5
        document.addEventListener('keydown', (e) => {
            if (e.key === 'F5') {
                e.preventDefault();
                iframe.src = iframe.src;
            }
        });
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js').catch(console.error);
            });
        }
    </script>
</body>
</html>
