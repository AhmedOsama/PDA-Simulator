<style>
  .pump-content-section {
    padding: 40px 20px;
    background: {{ section.settings.background_color }};
  }

  .pump-content-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 30px;
    max-width: 1200px;
    margin: 0 auto;
    align-items: center;
    justify-content: center;
  }

  .pump-content-block {
    flex: 1;
    min-width: 280px;
    max-width: 500px;
  }

  .pump-simulator-container {
    position: relative;
    width: 100%;
    max-width: 320px;
    aspect-ratio: 480 / 800;
    margin: 0 auto;
  }

  .pump-simulator-iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: none;
    border-radius: 20px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
    touch-action: pan-y pinch-zoom;
  }

  .pump-simulator-loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 14px;
    color: #666;
  }

  .pump-simulator-iframe.loaded + .pump-simulator-loading {
    display: none;
  }

  .pump-text-block h2 {
    margin-bottom: 15px;
    font-size: 28px;
  }

  .pump-text-block p {
    font-size: 16px;
    line-height: 1.6;
    color: #555;
  }

  .pump-image-block img {
    width: 100%;
    height: auto;
    border-radius: 12px;
  }

  /* Close button - hidden by default */
  .pump-simulator-close-btn {
    display: none;
    position: fixed;
    top: 10px;
    right: 10px;
    z-index: 10001;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    border: none;
    border-radius: 50%;
    width: 44px;
    height: 44px;
    font-size: 24px;
    cursor: pointer;
    align-items: center;
    justify-content: center;
    transition: background 0.2s ease;
  }

  .pump-simulator-close-btn:hover {
    background: rgba(0, 0, 0, 0.9);
  }

  /* ========================================
     MOBILE PORTRAIT MODE - Fullscreen takeover
     ======================================== */
  @media (max-width: 767px) {
    .pump-content-section {
      padding: 0;
    }

    .pump-content-grid {
      gap: 0;
    }

    .pump-content-block {
      min-width: 100%;
      max-width: 100%;
    }

    /* Hide other content blocks on mobile - show only simulator */
    .pump-content-block:not(:has(.pump-simulator-container)) {
      display: none;
    }

    /* Mobile fullscreen mode */
    .pump-simulator-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      height: 100dvh; /* Dynamic viewport height for mobile */
      max-width: none;
      max-height: none;
      aspect-ratio: unset;
      z-index: 10000;
      border-radius: 0;
      margin: 0;
    }

    .pump-simulator-iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 0;
      box-shadow: none;
    }

    /* Show close button on mobile */
    .pump-simulator-close-btn {
      display: flex;
    }
  }

  /* ========================================
     MOBILE LANDSCAPE MODE
     ======================================== */
  @media (max-width: 900px) and (orientation: landscape) {
    .pump-content-section {
      padding: 0;
    }

    .pump-content-grid {
      gap: 0;
    }

    .pump-content-block {
      min-width: 100%;
      max-width: 100%;
    }

    /* Hide other content blocks on mobile landscape */
    .pump-content-block:not(:has(.pump-simulator-container)) {
      display: none;
    }

    /* Landscape: full height, width scales to maintain aspect ratio */
    .pump-simulator-container {
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: auto;
      height: 100vh;
      height: 100dvh;
      max-width: calc(100vh * 480 / 740);
      max-width: calc(100dvh * 480 / 740);
      max-height: none;
      aspect-ratio: unset;
      z-index: 10000;
      border-radius: 0;
      margin: 0;
    }

    .pump-simulator-iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 0;
      box-shadow: none;
    }

    /* Show close button in landscape too */
    .pump-simulator-close-btn {
      display: flex;
    }
  }

  /* ========================================
     TABLET MODE
     ======================================== */
  @media (min-width: 768px) and (max-width: 1023px) {
    .pump-simulator-container {
      max-width: 400px;
    }

    .pump-simulator-close-btn {
      display: none;
    }
  }

  /* ========================================
     DESKTOP MODE - unchanged
     ======================================== */
  @media (min-width: 1024px) {
    .pump-simulator-container {
      max-width: 480px;
    }

    .pump-simulator-close-btn {
      display: none;
    }
  }
</style>

<div class="pump-content-section">
  <div class="pump-content-grid">
    {% for block in section.blocks %}
      <div class="pump-content-block" {{ block.shopify_attributes }}>
        {% case block.type %}

          {% when 'simulator' %}
            <div class="pump-simulator-container" id="pump-simulator-container-{{ block.id }}">
              <iframe
                id="pump-simulator-iframe-{{ block.id }}"
                class="pump-simulator-iframe"
                src="{{ block.settings.simulator_url | append: '?embed=1' }}"
                title="{{ block.settings.iframe_title }}"
                loading="lazy"
                allow="fullscreen"
                onload="this.classList.add('loaded')"
              ></iframe>
              <div class="pump-simulator-loading">جاري التحميل...</div>
              <button class="pump-simulator-close-btn" onclick="exitSimulatorFullscreen()" aria-label="Close simulator">✕</button>
            </div>

          {% when 'text' %}
            <div class="pump-text-block">
              {% if block.settings.heading != blank %}
                <h2>{{ block.settings.heading }}</h2>
              {% endif %}
              {% if block.settings.text != blank %}
                <p>{{ block.settings.text }}</p>
              {% endif %}
            </div>

          {% when 'image' %}
            <div class="pump-image-block">
              {% if block.settings.image != blank %}
                <img src="{{ block.settings.image | image_url: width: 800 }}" alt="{{ block.settings.image.alt | default: 'Image' }}">
              {% else %}
                {{ 'image' | placeholder_svg_tag: 'placeholder-svg' }}
              {% endif %}
            </div>

          {% when 'html' %}
            <div class="pump-html-block">
              {{ block.settings.html_content }}
            </div>

        {% endcase %}
      </div>
    {% endfor %}
  </div>
</div>

<script>
  /**
   * Exit simulator fullscreen mode
   * Navigates back or scrolls to section depending on context
   */
  function exitSimulatorFullscreen() {
    // Try to navigate back if there's history
    if (window.history.length > 1) {
      window.history.back();
    } else {
      // Fallback: scroll to the section or navigate to homepage
      window.location.href = '{{ shop.url }}';
    }
  }

  /**
   * Handle body scroll lock when simulator is in fullscreen
   */
  (function() {
    const isMobile = window.matchMedia('(max-width: 767px)').matches ||
                     (window.matchMedia('(max-width: 900px)').matches &&
                      window.matchMedia('(orientation: landscape)').matches);

    if (isMobile) {
      // Lock body scroll on mobile when simulator takes over
      document.body.style.overflow = 'hidden';
      document.body.style.position = 'fixed';
      document.body.style.width = '100%';
      document.body.style.height = '100%';
    }

    // Re-evaluate on resize/orientation change
    window.addEventListener('resize', function() {
      const nowMobile = window.matchMedia('(max-width: 767px)').matches ||
                        (window.matchMedia('(max-width: 900px)').matches &&
                         window.matchMedia('(orientation: landscape)').matches);

      if (nowMobile) {
        document.body.style.overflow = 'hidden';
        document.body.style.position = 'fixed';
        document.body.style.width = '100%';
        document.body.style.height = '100%';
      } else {
        document.body.style.overflow = '';
        document.body.style.position = '';
        document.body.style.width = '';
        document.body.style.height = '';
      }
    });
  })();
</script>

{% schema %}
{
  "name": "Pump Simulator + Content",
  "tag": "section",
  "class": "pump-simulator-content-section",
  "settings": [
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color",
      "default": "#f5f5f5"
    }
  ],
  "blocks": [
    {
      "type": "simulator",
      "name": "Pump Simulator",
      "settings": [
        {
          "type": "text",
          "id": "simulator_url",
          "label": "Simulator URL",
          "default": "https://ahmedosama.github.io/PDA-Simulator/pda-mode.html",
          "info": "The ?embed=1 parameter will be added automatically"
        },
        {
          "type": "text",
          "id": "iframe_title",
          "label": "Accessibility Title",
          "default": "Insulin Pump Simulator"
        }
      ]
    },
    {
      "type": "text",
      "name": "Text",
      "settings": [
        {
          "type": "text",
          "id": "heading",
          "label": "Heading",
          "default": "About the Simulator"
        },
        {
          "type": "richtext",
          "id": "text",
          "label": "Text",
          "default": "<p>Learn how to use the insulin pump with our interactive simulator.</p>"
        }
      ]
    },
    {
      "type": "image",
      "name": "Image",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        }
      ]
    },
    {
      "type": "html",
      "name": "Custom HTML",
      "settings": [
        {
          "type": "html",
          "id": "html_content",
          "label": "HTML Content"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Pump Simulator + Content",
      "blocks": [
        {
          "type": "simulator"
        },
        {
          "type": "text"
        }
      ]
    }
  ]
}
{% endschema %}
